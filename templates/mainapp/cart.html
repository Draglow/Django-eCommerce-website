{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <h1 class="h4 mb-0">Shopping Cart</h1>
        <span class="badge bg-primary ms-2">{{ cart.items.count|default:0 }} items</span>
    </div>
    
    {% if request.user.is_authenticated %}
        {% if cart and cart.items.exists %}
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-3 p-md-4">
                            {% for item in cart.items.all %}
                            <div class="cart-item p-2 p-md-3 mb-3 rounded-3 bg-light fade-in" id="cart-item-{{ item.id }}">
                                <div class="row align-items-center g-2">
                                    <div class="col-3 col-md-2">
                                    {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" 
                                                 class="img-fluid rounded-3 shadow-sm" 
                                                 alt="{{ item.product.name }}"
                                                 style="height: 60px; width: 60px; object-fit: cover;">
                                    {% endif %}
                                </div>
                                    <div class="col-9 col-md-4">
                                        <h5 class="card-title h6 mb-1">{{ item.product.name }}</h5>
                                        <p class="text-muted small mb-0">${{ item.product.price }}</p>
                                </div>
                                    <div class="col-12 col-md-3">
                                        <div class="input-group input-group-sm" style="max-width: 120px;">
                                        <button class="btn btn-outline-secondary update-quantity" 
                                                data-item-id="{{ item.id }}" 
                                                    data-action="decrease">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" 
                                                   class="form-control text-center quantity-input" 
                                                   value="{{ item.quantity }}" 
                                                   min="1" 
                                               data-item-id="{{ item.id }}">
                                        <button class="btn btn-outline-secondary update-quantity" 
                                                data-item-id="{{ item.id }}" 
                                                    data-action="increase">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-2">
                                        <p class="fw-bold mb-0 small">${{ item.get_cost }}</p>
                                </div>
                                    <div class="col-6 col-md-1 text-end">
                                        <button class="btn btn-link text-danger p-0 remove-item" 
                                                data-item-id="{{ item.id }}"
                                                data-bs-toggle="tooltip"
                                                title="Remove item">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm mb-4 mb-lg-0">
                        <div class="card-body p-3 p-md-4">
                            <h5 class="card-title h6 mb-3">Order Summary</h5>
                            
                            <div class="d-flex justify-content-between mb-2 small">
                                <span class="text-muted">Subtotal</span>
                                <span>${{ cart.get_total }}</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2 small">
                                <span class="text-muted">Shipping</span>
                                <span>Free</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2 small">
                                <span class="text-muted">Tax</span>
                                <span>$0.00</span>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total</strong>
                                <strong class="text-primary">${{ cart.get_total }}</strong>
                            </div>
                            
                            <form class="mb-3" id="coupon-form">
                                <div class="input-group input-group-sm">
                                    <input type="text" 
                                           class="form-control" 
                                           id="coupon-code" 
                                           placeholder="Enter coupon code">
                                    <button class="btn btn-outline-primary" 
                                            type="submit" 
                                            id="apply-coupon">
                                        Apply
                                    </button>
                                </div>
                            </form>
                            
                            <a href="{% url 'mainapp:checkout' %}" 
                               class="btn btn-primary w-100 mb-2">
                                Proceed to Checkout
                            </a>
                            
                            <a href="{% url 'mainapp:product_list' %}" 
                               class="btn btn-outline-secondary w-100">
                                Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="empty-cart-icon mb-4">
                    <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                </div>
                <h3 class="h5 mb-3">Your cart is empty</h3>
                <p class="text-muted small mb-4">Looks like you haven't added any items to your cart yet.</p>
                <a href="{% url 'mainapp:product_list' %}" 
                   class="btn btn-primary">
                    Start Shopping
                </a>
            </div>
        {% endif %}
    {% else %}
        {% if cart_items %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3 p-md-4">
            <div class="table-responsive">
                        <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                                    <th class="small">Product</th>
                                    <th class="small">Price</th>
                                    <th class="small">Quantity</th>
                                    <th class="small">Subtotal</th>
                                    <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart_items %}
                                    <tr class="fade-in">
                                <td>
                                            <div class="d-flex align-items-center">
                                    {% if item.product.image %}
                                                    <img src="{{ item.product.image.url }}" 
                                                         alt="{{ item.product.name }}" 
                                                         class="rounded-3 me-2"
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                    {% endif %}
                                                <span class="small">{{ item.product.name }}</span>
                                            </div>
                                </td>
                                        <td class="small">${{ item.product.price }}</td>
                                        <td>
                                            <div class="input-group input-group-sm" style="width: 100px;">
                                                <button class="btn btn-outline-secondary decrease-quantity" 
                                                        data-product-id="{{ item.product.id }}">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" 
                                                       class="form-control text-center quantity-input" 
                                                       value="{{ item.quantity }}" 
                                                       min="1" 
                                                       data-product-id="{{ item.product.id }}">
                                                <button class="btn btn-outline-secondary increase-quantity" 
                                                        data-product-id="{{ item.product.id }}">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                    </div>
                                </td>
                                        <td class="small">${{ item.subtotal }}</td>
                                <td>
                                            <button class="btn btn-link text-danger p-0 remove-item" 
                                                    data-product-id="{{ item.product.id }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
                    
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 mt-4">
                        <a href="{% url 'mainapp:product_list' %}" 
                           class="btn btn-outline-secondary w-100">
                            Continue Shopping
                        </a>
                        <a href="{% url 'account_login' %}" 
                           class="btn btn-primary w-100">
                            Login to Checkout
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="empty-cart-icon mb-4">
                    <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                </div>
                <h3 class="h5 mb-3">Your cart is empty</h3>
                <p class="text-muted small mb-4">Looks like you haven't added any items to your cart yet.</p>
                <a href="{% url 'mainapp:product_list' %}" 
                   class="btn btn-primary">
                    Start Shopping
                </a>
            </div>
        {% endif %}
    {% endif %}
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to update prices in real-time
    function updatePrices(itemId, quantity, isLoggedIn) {
        let cartItem;
        if (isLoggedIn) {
            cartItem = document.getElementById(`cart-item-${itemId}`);
        } else {
            // For non-logged in users, find the row containing the product
            cartItem = document.querySelector(`[data-product-id="${itemId}"]`).closest('tr');
        }
        if (!cartItem) return;

        const priceElement = isLoggedIn ? 
            cartItem.querySelector('.text-muted.small') :
            cartItem.querySelector('td:nth-child(2)');
        const subtotalElement = isLoggedIn ?
            cartItem.querySelector('.fw-bold.mb-0.small') :
            cartItem.querySelector('td:nth-child(4)');
        
        if (priceElement && subtotalElement) {
            const price = parseFloat(priceElement.textContent.replace('$', ''));
            const newSubtotal = price * quantity;
            subtotalElement.textContent = `$${newSubtotal.toFixed(2)}`;
            
            // Update total
            updateTotal();
        }
    }

    // Function to update total price
    function updateTotal() {
        let total = 0;
        // Handle both logged-in and non-logged-in cases
        const subtotalElements = document.querySelectorAll('.fw-bold.mb-0.small, td:nth-child(4)');
        subtotalElements.forEach(element => {
            if (element.textContent.includes('$')) {
            total += parseFloat(element.textContent.replace('$', ''));
            }
        });
        
        const totalElement = document.querySelector('.card-body .d-flex.justify-content-between.mb-3 strong:last-child');
        if (totalElement) {
            totalElement.textContent = `$${total.toFixed(2)}`;
        }
    }

    // Function to update cart count
    function updateCartCount(count) {
        const cartBadges = document.querySelectorAll('.cart-badge');
        cartBadges.forEach(badge => {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        });
    }

    // Initialize prices on page load
    function initializePrices() {
        // Handle logged-in case
        document.querySelectorAll('.cart-item').forEach(cartItem => {
            const itemId = cartItem.id.split('-')[2];
            const quantityInput = cartItem.querySelector(`input[data-item-id="${itemId}"]`);
            if (quantityInput) {
                updatePrices(itemId, parseInt(quantityInput.value), true);
            }
        });

        // Handle non-logged-in case
        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const productId = row.dataset.productId;
            const quantityInput = row.querySelector(`input[data-product-id="${productId}"]`);
            if (quantityInput) {
                updatePrices(productId, parseInt(quantityInput.value), false);
            }
        });
    }

    // Call initializePrices when page loads
    initializePrices();

    // Update quantity for both logged-in and non-logged-in users
    document.querySelectorAll('.update-quantity, .increase-quantity, .decrease-quantity').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId || this.dataset.productId;
            const isLoggedIn = !!this.dataset.itemId;
            const action = this.dataset.action || (this.classList.contains('increase-quantity') ? 'increase' : 'decrease');
            const input = document.querySelector(`input[data-${isLoggedIn ? 'item' : 'product'}-id="${itemId}"]`);
            let quantity = parseInt(input.value);
            
            if (action === 'increase') {
                quantity++;
            } else if (action === 'decrease' && quantity > 1) {
                quantity--;
            }
            
            input.value = quantity;
            // Update prices immediately
            updatePrices(itemId, quantity, isLoggedIn);
            // Then update server
            updateCartItem(itemId, quantity, isLoggedIn);
        });
    });

    // Remove item for both logged-in and non-logged-in users
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId || this.dataset.productId;
            const isLoggedIn = !!this.dataset.itemId;
            const cartItem = isLoggedIn ? 
                document.getElementById(`cart-item-${itemId}`) :
                this.closest('tr');
            
            // Get current cart count before removal
            const currentCount = parseInt(document.querySelector('.cart-badge').textContent);
            
            // Remove item immediately
            if (cartItem) {
                cartItem.style.opacity = '0';
                setTimeout(() => {
                    cartItem.remove();
                    // Update total after removal
                    updateTotal();
                    // Update cart count by decrementing by 1
                    if (!isNaN(currentCount) && currentCount > 0) {
                        updateCartCount(currentCount - 1);
                    }
                }, 300);
            }
            
            // Then update server
            removeCartItem(itemId, currentCount, isLoggedIn);
        });
    });

    function removeCartItem(itemId, currentCount, isLoggedIn) {
        fetch(isLoggedIn ? '{% url "mainapp:cart_remove" %}' : '{% url "mainapp:cart_remove_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                [isLoggedIn ? 'item_id' : 'product_id']: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Item removed from cart!', 'success');
                // Update cart count from server response
                if (data.cart_count !== undefined) {
                    updateCartCount(data.cart_count);
                } else {
                    // Fallback to decrementing if server count is not available
                    if (!isNaN(currentCount) && currentCount > 0) {
                        updateCartCount(currentCount - 1);
                    }
                }
                // If cart is empty, reload the page
                if (data.cart_count === 0) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            } else {
                showToast('Error', data.message || 'Failed to remove item.', 'danger');
                // Revert the cart count if the server request failed
                if (!isNaN(currentCount)) {
                    updateCartCount(currentCount);
                }
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to remove item.', 'danger');
            console.error('Error:', error);
            // Revert the cart count if the server request failed
            if (!isNaN(currentCount)) {
                updateCartCount(currentCount);
            }
        });
    }

    function updateCartItem(itemId, quantity, isLoggedIn) {
        fetch(isLoggedIn ? '{% url "mainapp:cart_update" %}' : '{% url "mainapp:cart_update_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                [isLoggedIn ? 'item_id' : 'product_id']: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', 'Quantity updated successfully!', 'success');
            } else {
                showToast('Error', data.message || 'Failed to update quantity.', 'danger');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to update quantity.', 'danger');
            console.error('Error:', error);
        });
    }

    // Apply coupon
    const couponForm = document.getElementById('coupon-form');
    if (couponForm) {
        couponForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById('coupon-code').value;
            applyCoupon(code);
        });
    }

    function applyCoupon(code) {
        fetch('{% url "mainapp:apply_coupon" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                code: code
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                updateCartDisplay(data);
                showToast('Success', 'Coupon applied successfully!', 'success');
            } else {
                showToast('Error', 'Invalid coupon code.', 'danger');
            }
        })
        .catch(error => {
            showToast('Error', 'Failed to apply coupon.', 'danger');
            console.error('Error:', error);
        });
    }

    function updateCartDisplay(data) {
        // Update cart count in navbar
        const cartBadge = document.querySelector('.cart-badge');
        if (cartBadge) {
            cartBadge.textContent = data.cart_count;
            if (data.cart_count > 0) {
                cartBadge.style.display = 'block';
            } else {
                cartBadge.style.display = 'none';
            }
        }

        // Update total
        const totalElement = document.querySelector('.card-body .d-flex.justify-content-between.mb-3 strong:last-child');
        if (totalElement && data.cart_total) {
            totalElement.textContent = `$${data.cart_total}`;
        }

        // Update subtotal
        const subtotalElement = document.querySelector('.card-body .d-flex.justify-content-between.mb-2 span:last-child');
        if (subtotalElement && data.discount_amount) {
            const originalTotal = parseFloat(data.cart_total) + parseFloat(data.discount_amount);
            subtotalElement.textContent = `$${originalTotal.toFixed(2)}`;
            
            // Add discount display if it doesn't exist
            let discountElement = document.querySelector('.discount-display');
            if (!discountElement) {
                discountElement = document.createElement('div');
                discountElement.className = 'd-flex justify-content-between mb-2 small discount-display';
                discountElement.innerHTML = `
                    <span class="text-muted">Discount</span>
                    <span class="text-success">-$${data.discount_amount}</span>
                `;
                subtotalElement.parentElement.insertAdjacentElement('afterend', discountElement);
            } else {
                discountElement.querySelector('span:last-child').textContent = `-$${data.discount_amount}`;
            }
        }

        // If cart is empty, reload the page
        if (data.cart_count === 0) {
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
    }

    function showToast(title, message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
});
</script>
{% endblock %} 